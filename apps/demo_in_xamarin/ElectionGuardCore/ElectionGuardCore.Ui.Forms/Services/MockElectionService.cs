using System.Collections.Generic;
using System.Threading.Tasks;
using ElectionGuardCore.Elections;
using Newtonsoft.Json;
using Newtonsoft.Json.Converters;
using Newtonsoft.Json.Serialization;

namespace ElectionGuardCore.Ui.Forms.Services
{
    internal class MockElectionService : IElectionService
    {
        private readonly JsonSerializerSettings _serializerSettings;
        private readonly Dictionary<string, bool> _votes = new Dictionary<string, bool>();

        public MockElectionService()
        {
            _serializerSettings = new JsonSerializerSettings
            {
                ContractResolver = new DefaultContractResolver
                {
                    NamingStrategy = new SnakeCaseNamingStrategy()
                },
                Converters = new List<JsonConverter>
                {
                    new StringEnumConverter(typeof(SnakeCaseNamingStrategy)),
                    new ElementConverter()
                }
            };
        }

        private static readonly string SampleElectionDescriptionJson = "{\"contests\":[{\"type\":null,\"object_id\":\"president-vice-president-contest\",\"sequence_order\":0,\"ballot_selections\":[{\"object_id\":\"barchi-hallaren-selection\",\"candidate_id\":\"barchi-hallaren\",\"sequence_order\":0},{\"object_id\":\"cramer-vuocolo-selection\",\"candidate_id\":\"cramer-vuocolo\",\"sequence_order\":1},{\"object_id\":\"court-blumhardt-selection\",\"candidate_id\":\"court-blumhardt\",\"sequence_order\":2},{\"object_id\":\"boone-lian-selection\",\"candidate_id\":\"boone-lian\",\"sequence_order\":3},{\"object_id\":\"hildebrand-garritty-selection\",\"candidate_id\":\"hildebrand-garritty\",\"sequence_order\":4},{\"object_id\":\"patterson-lariviere-selection\",\"candidate_id\":\"patterson-lariviere\",\"sequence_order\":5},{\"object_id\":\"write-in-selection-president\",\"candidate_id\":\"write-in\",\"sequence_order\":6}],\"ballot_title\":{\"text\":[{\"value\":\"President and Vice President of the United States\",\"language\":\"en\"},{\"value\":\"Presidente y Vicepresidente de los Estados Unidos\",\"language\":\"es\"}]},\"ballot_subtitle\":{\"text\":[{\"value\":\"Vote for one\",\"language\":\"en\"},{\"value\":\"Votar por uno\",\"language\":\"es\"}]},\"vote_variation\":\"one_of_m\",\"electoral_district_id\":\"hamilton-county\",\"name\":\"President and Vice President of the United States\",\"primary_party_ids\":null,\"number_elected\":1,\"votes_allowed\":1},{\"type\":null,\"object_id\":\"ozark-governor\",\"sequence_order\":1,\"ballot_selections\":[{\"object_id\":\"franz-selection\",\"candidate_id\":\"franz\",\"sequence_order\":0},{\"object_id\":\"harris-selection\",\"candidate_id\":\"harris\",\"sequence_order\":1},{\"object_id\":\"bargmann-selection\",\"candidate_id\":\"bargmann\",\"sequence_order\":2},{\"object_id\":\"abcock-selection\",\"candidate_id\":\"abcock\",\"sequence_order\":3},{\"object_id\":\"steel-loy-selection\",\"candidate_id\":\"steel-loy\",\"sequence_order\":4},{\"object_id\":\"sharp-selection\",\"candidate_id\":\"sharp\",\"sequence_order\":5},{\"object_id\":\"walace-selection\",\"candidate_id\":\"wallace\",\"sequence_order\":6},{\"object_id\":\"williams-selection\",\"candidate_id\":\"williams\",\"sequence_order\":7},{\"object_id\":\"alpern-selection\",\"candidate_id\":\"alpern\",\"sequence_order\":9},{\"object_id\":\"windbeck-selection\",\"candidate_id\":\"windbeck\",\"sequence_order\":10},{\"object_id\":\"sharp-althea-selection\",\"candidate_id\":\"sharp-althea\",\"sequence_order\":11},{\"object_id\":\"greher-selection\",\"candidate_id\":\"greher\",\"sequence_order\":12},{\"object_id\":\"alexander-selection\",\"candidate_id\":\"alexander\",\"sequence_order\":13},{\"object_id\":\"mitchell-selection\",\"candidate_id\":\"mitchell\",\"sequence_order\":14},{\"object_id\":\"lee-selection\",\"candidate_id\":\"lee\",\"sequence_order\":15},{\"object_id\":\"ash-selection\",\"candidate_id\":\"ash\",\"sequence_order\":16},{\"object_id\":\"kennedy-selection\",\"candidate_id\":\"kennedy\",\"sequence_order\":17},{\"object_id\":\"jackson-selection\",\"candidate_id\":\"jackson\",\"sequence_order\":18},{\"object_id\":\"brown-selection\",\"candidate_id\":\"brown\",\"sequence_order\":19},{\"object_id\":\"teller-selection\",\"candidate_id\":\"teller\",\"sequence_order\":20},{\"object_id\":\"ward-selection\",\"candidate_id\":\"ward\",\"sequence_order\":21},{\"object_id\":\"murphy-selection\",\"candidate_id\":\"murphy\",\"sequence_order\":22},{\"object_id\":\"newman-selection\",\"candidate_id\":\"newman\",\"sequence_order\":23},{\"object_id\":\"callanann-selection\",\"candidate_id\":\"callanann\",\"sequence_order\":24},{\"object_id\":\"york-selection\",\"candidate_id\":\"york\",\"sequence_order\":25},{\"object_id\":\"chandler-selection\",\"candidate_id\":\"chandler\",\"sequence_order\":26},{\"object_id\":\"write-in-selection-governor\",\"candidate_id\":\"write-in\",\"sequence_order\":27}],\"ballot_title\":{\"text\":[{\"value\":\"Governor of the Commonwealth of Ozark\",\"language\":\"en\"},{\"value\":\"Gobernador de la Mancomunidad de Ozark\",\"language\":\"es\"}]},\"ballot_subtitle\":{\"text\":[{\"value\":\"Vote for one\",\"language\":\"en\"},{\"value\":\"Votar por uno\",\"language\":\"es\"}]},\"vote_variation\":\"one_of_m\",\"electoral_district_id\":\"hamilton-county\",\"name\":\"Governor of the Commonwealth of Ozark\",\"primary_party_ids\":null,\"number_elected\":1,\"votes_allowed\":1},{\"type\":null,\"object_id\":\"congress-district-5-contest\",\"sequence_order\":2,\"ballot_selections\":[{\"object_id\":\"soliz-selection\",\"candidate_id\":\"soliz\",\"sequence_order\":0},{\"object_id\":\"keller-selection\",\"candidate_id\":\"keller\",\"sequence_order\":1},{\"object_id\":\"rangel-selection\",\"candidate_id\":\"rengel\",\"sequence_order\":2},{\"object_id\":\"argent-selection\",\"candidate_id\":\"argent\",\"sequence_order\":3},{\"object_id\":\"witherspoon-smithson-selection\",\"candidate_id\":\"witherspoon-smithson\",\"sequence_order\":4},{\"object_id\":\"write-in-selection-us-congress-district-5\",\"candidate_id\":\"write-in\",\"sequence_order\":5}],\"ballot_title\":{\"text\":[{\"value\":\"House of Representatives Congressional District 5\",\"language\":\"en\"},{\"value\":\"Cámara de Representantes de Distrito 5 del Congreso de Ozark\",\"language\":\"es\"}]},\"ballot_subtitle\":{\"text\":[{\"value\":\"Vote for one\",\"language\":\"en\"},{\"value\":\"Votar por uno\",\"language\":\"es\"}]},\"vote_variation\":\"one_of_m\",\"electoral_district_id\":\"congress-district-5\",\"name\":\"Congressional District 5\",\"primary_party_ids\":null,\"number_elected\":1,\"votes_allowed\":1},{\"type\":null,\"object_id\":\"congress-district-7-contest\",\"sequence_order\":3,\"ballot_selections\":[{\"object_id\":\"bainbridge-selection\",\"candidate_id\":\"bainbridge\",\"sequence_order\":0},{\"object_id\":\"hennessey-selection\",\"candidate_id\":\"hennessey\",\"sequence_order\":1},{\"object_id\":\"savoy-selection\",\"candidate_id\":\"savoy\",\"sequence_order\":2},{\"object_id\":\"tawa-selection\",\"candidate_id\":\"tawa\",\"sequence_order\":3},{\"object_id\":\"tawa-mary-selection\",\"candidate_id\":\"tawa-mary\",\"sequence_order\":4},{\"object_id\":\"write-in-selection-us-congress-district-7\",\"candidate_id\":\"write-in\",\"sequence_order\":5}],\"ballot_title\":{\"text\":[{\"value\":\"House of Representatives Ozark Congressional District 7\",\"language\":\"en\"},{\"value\":\"Cámara de Representantes de Distrito 7 del Congreso de Ozark\",\"language\":\"es\"}]},\"ballot_subtitle\":{\"text\":[{\"value\":\"Vote for one\",\"language\":\"en\"},{\"value\":\"Votar por uno\",\"language\":\"es\"}]},\"vote_variation\":\"one_of_m\",\"electoral_district_id\":\"congress-district-7\",\"name\":\"Congressional District 7\",\"primary_party_ids\":null,\"number_elected\":1,\"votes_allowed\":1},{\"type\":null,\"object_id\":\"pismo-beach-school-board-contest\",\"sequence_order\":4,\"ballot_selections\":[{\"object_id\":\"moore-selection\",\"candidate_id\":\"moore\",\"sequence_order\":0},{\"object_id\":\"white-selection\",\"candidate_id\":\"white\",\"sequence_order\":1},{\"object_id\":\"smallberries-selection\",\"candidate_id\":\"smallberries\",\"sequence_order\":2},{\"object_id\":\"warfin-selection\",\"candidate_id\":\"warfin\",\"sequence_order\":3},{\"object_id\":\"norberg-selection\",\"candidate_id\":\"norberg\",\"sequence_order\":4},{\"object_id\":\"parks-selection\",\"candidate_id\":\"parks\",\"sequence_order\":5},{\"object_id\":\"savannah-selection\",\"candidate_id\":\"savannah\",\"sequence_order\":6},{\"object_id\":\"write-in-selection-1-pismo-beach-school-board\",\"candidate_id\":\"write-in-1\",\"sequence_order\":7},{\"object_id\":\"write-in-selection-2-pismo-beach-school-board\",\"candidate_id\":\"write-in-2\",\"sequence_order\":8},{\"object_id\":\"write-in-selection-3-pismo-beach-school-board\",\"candidate_id\":\"write-in-3\",\"sequence_order\":9}],\"ballot_title\":{\"text\":[{\"value\":\"Pismo Beach School Board\",\"language\":\"en\"},{\"value\":\"Junta Escolar de Pismo Beach\",\"language\":\"es\"}]},\"ballot_subtitle\":{\"text\":[{\"value\":\"Vote for up to 3\",\"language\":\"en\"},{\"value\":\"Vote por hasta 3\",\"language\":\"es\"}]},\"vote_variation\":\"n_of_m\",\"electoral_district_id\":\"pismo-beach-school-district-precinct-1\",\"name\":\"Pismo Beach School Board\",\"primary_party_ids\":null,\"number_elected\":3,\"votes_allowed\":3},{\"type\":null,\"object_id\":\"somerset-school-board-contest\",\"sequence_order\":5,\"ballot_selections\":[{\"object_id\":\"summers-selection\",\"candidate_id\":\"summers\",\"sequence_order\":0},{\"object_id\":\"chase-selection\",\"candidate_id\":\"chase\",\"sequence_order\":1},{\"object_id\":\"osborne-selection\",\"candidate_id\":\"osborne\",\"sequence_order\":2},{\"object_id\":\"rosenberg-selection\",\"candidate_id\":\"rosenberg\",\"sequence_order\":3},{\"object_id\":\"head-selection\",\"candidate_id\":\"head\",\"sequence_order\":4},{\"object_id\":\"marsters-selection\",\"candidate_id\":\"marsters\",\"sequence_order\":5},{\"object_id\":\"write-in-selection-1-somerset-school-board\",\"candidate_id\":\"write-in-1\",\"sequence_order\":6},{\"object_id\":\"write-in-selection-2-somerset-school-board\",\"candidate_id\":\"write-in-2\",\"sequence_order\":7}],\"ballot_title\":{\"text\":[{\"value\":\"Pismo Beach School Board\",\"language\":\"en\"},{\"value\":\"Junta Escolar de Somerset\",\"language\":\"es\"}]},\"ballot_subtitle\":{\"text\":[{\"value\":\"Vote for up to 2\",\"language\":\"en\"},{\"value\":\"Vote por hasta 2\",\"language\":\"es\"}]},\"vote_variation\":\"n_of_m\",\"electoral_district_id\":\"somerset-school-district-precinct-1\",\"name\":\"Somerset School Board\",\"primary_party_ids\":null,\"number_elected\":2,\"votes_allowed\":2},{\"type\":null,\"object_id\":\"arlington-chief-justice-retain-demergue\",\"sequence_order\":6,\"ballot_selections\":[{\"object_id\":\"ozark-chief-justice-retain-demergue-affirmative-selection\",\"candidate_id\":\"ozark-chief-justice-retain-demergue-affirmative\",\"sequence_order\":0},{\"object_id\":\"ozark-chief-justice-retain-demergue-negative-selection\",\"candidate_id\":\"ozark-chief-justice-retain-demergue-negative\",\"sequence_order\":1}],\"ballot_title\":{\"text\":[{\"value\":\"Retain Robert Demergue as Chief Justice?\",\"language\":\"en\"},{\"value\":\"¿Retener a Robert Demergue como Presidente del Tribunal Supremo?\",\"language\":\"es\"}]},\"ballot_subtitle\":{\"text\":[{\"value\":\"Choose \'Accept\' or \'Reject\'\",\"language\":\"en\"},{\"value\":\"Elija \'Aceptar\' o \'Rechazar\'\",\"language\":\"es\"}]},\"vote_variation\":\"one_of_m\",\"electoral_district_id\":\"arlington-township-precinct-1\",\"name\":\"Retain Robert Demergue as Chief Justice?\",\"primary_party_ids\":null,\"number_elected\":1,\"votes_allowed\":1},{\"type\":null,\"object_id\":\"exeter-utility-district-referendum-contest\",\"sequence_order\":7,\"ballot_selections\":[{\"object_id\":\"exeter-utility-district-referendum-affirmative-selection\",\"candidate_id\":\"exeter-utility-district-referendum-affirmative\",\"sequence_order\":0},{\"object_id\":\"exeter-utility-district-referendum-selection\",\"candidate_id\":\"exeter-utility-district-referendum-negative\",\"sequence_order\":1}],\"ballot_title\":{\"text\":[{\"value\":\"Levy Lift to Maintain Public Safety and Other Core Utility Services\",\"language\":\"en\"},{\"value\":\"Levy Lift para Mantener la Seguridad Pública y Otros Servicios Básicos\",\"language\":\"es\"}]},\"ballot_subtitle\":{\"text\":[{\"value\":\"Should this Proposition be approved?\",\"language\":\"en\"},{\"value\":\"Uno\",\"language\":\"es\"}]},\"vote_variation\":\"one_of_m\",\"electoral_district_id\":\"lacroix-exeter-utility-district\",\"name\":\"Capital Projects Levy\",\"primary_party_ids\":null,\"number_elected\":1,\"votes_allowed\":1}],\"description_hash\":\"57761467C208DB32568752D4349702144E26F21FE063E5C3480965867E6F04B9\"}";

        private static readonly string SampleCiphertextelectionContextJson = "{\"crypto_base_hash\": \"113133177615765376285011049573550420815271886877763010626891582395189234851926\", \"crypto_extended_base_hash\": \"105453391201168277388902836868037575613019125079321017624607857728655939685293\", \"description_hash\": \"53955750461069851967519202298702206066009470464098563801488249985305233352944\", \"elgamal_public_key\": \"650903852758409990312291004707477534089130033640662303715889879300347470392572690670101560912298594019829500498680782581572320776102549359895131407798036010654305977756399507847597479423671994208260039161369645650200942975974929953888903769695737089030275004229889476017798210970661871162275031836161607571451823712343702817531718010784271941394242942006265819298593036639468800809490092770569604506388439055292605497883778779611729789663664798167171674337068864723339201806682926014651803729389240636842705316934200504855627368696961128633360112017545267132035378493927445218628450907731842309001212988582993449142731558063793504208297748527143100200065294394641695565727310707322384170547753676466622210526941258867623997491196087758801720083186367809900514525632362462844385192386919825231284597310902731851602135234568810844789653646269937313911984366094930582328113744033618007077931478678652204258800943529497120480504301445563522118452831782982792079277539134130956843111167981302599894866033073072191529549456530244798319208372693788385873385381417507913172762961192775063726092027733799628281766673150600650635616539905903227431959490156343811435649089212902563459216275058506452739629763054946580522277008451961937902994906\", \"number_of_guardians\": 5, \"quorum\": 3}";

        public Task<Election> GetElection()
        {
            var electionDescription =
                JsonConvert.DeserializeObject<ElectionDescription>(SampleElectionDescriptionJson, _serializerSettings);
            var election = new Election
            {
                Id = "42",
                ElectionDescription = electionDescription,
                State = ElectionState.Open
            };
            return Task.FromResult(election);
        }

        public Task<CiphertextElectionContext> GetCiphertextElectionContext(string electionId)
        {
            var ciphertextelectionContext =
                JsonConvert.DeserializeObject<CiphertextElectionContext>(SampleCiphertextelectionContextJson,
                    _serializerSettings);
            return Task.FromResult(ciphertextelectionContext);
        }

        public Task CastBallot(string electionId, CiphertextBallot ballot)
        {
            _votes[electionId] = true;
            return Task.CompletedTask;
        }

        public Task SpoilBallot(string electionId, CiphertextBallot ballot)
        {
            _votes[electionId] = false;
            return Task.CompletedTask;
        }

        public Task<bool> HasVoted(string electionId)
        {
            var hasVoted = _votes.ContainsKey(electionId) && _votes[electionId];
            return Task.FromResult(hasVoted);
        }
    }
}
